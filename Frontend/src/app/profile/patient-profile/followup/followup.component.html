<p-toast></p-toast>

<div
  *ngIf="!patStore.isLoadingFol() && !patStore.isLoadingDoc(); else loadingContainer"
  class="flex flex-col h-dvh"
>
  <!-- LIST VIEW -->
  <div *ngIf="currentView() === 'list'" class="p-3 flex flex-col gap-3">
    <div class="flex justify-between flex-col md:flex-row gap-3">
      <h2 class="font-semibold font-title text-3xl">Followup History</h2>
      <p-button
        type="button"
        label="New Follow-up"
        icon="pi pi-plus"
        (onClick)="switchToForm()"
      ></p-button>
    </div>

    <div class="flex flex-col gap-3">
      <div
        *ngFor="
          let followup of patStore.followups();
          trackBy: trackByFollowupId
        "
        class="bg-white flex flex-col gap-3 rounded-lg shadow-md border border-gray-300 p-3"
      >
        <h2 class="font-title text-xl font-semibold">
          Doctor: {{ getDoctorName(followup.doctor.id) }}
        </h2>

        <div class="border border-black rounded-lg flex flex-col gap-3">
          <h2 class="font-semibold text-slate-500 border-b p-2 border-black">
            Details
          </h2>
          <div class="flex flex-col gap-3 p-2">
            <div>Date: {{ followup.followupDate }}</div>
            <div>
              Status:
              <p-tag
                [value]="followup.status"
                styleClass="ml-2"
                [severity]="getSeverity(followup.status)"
              ></p-tag>
            </div>
          </div>
        </div>

        <div *ngIf="followup.status === 'Acheived'" class="md:text-end">
          <p-button
            label="See Report"
            icon="pi pi-file-pdf"
            severity="danger"
          ></p-button>
        </div>
      </div>

      <div
        *ngIf="patStore.followups().length === 0"
        class="text-center text-gray-500"
      >
        No follow-up records found.
      </div>
    </div>
  </div>

  <!-- FORM VIEW -->
  <div *ngIf="currentView() === 'form'" class="m-3 bg-white p-6 grow">
    <h2 class="font-title font-semibold text-2xl">Schedule Follow-up</h2>
    <p-divider></p-divider>

    <form class="flex flex-col p-3 gap-3" (ngSubmit)="onSubmit()">
      <div class="flex flex-col gap-3">
        <label for="doctor">Doctor</label>
        <p-select
          name="doctorId"
          [options]="doctorOptions()"
          [ngModel]="doctorId()"
          (ngModelChange)="doctorId.set($event)"
          placeholder="Select a doctor"
          optionLabel="label"
          optionValue="value"
        ></p-select>
        <small *ngIf="!doctorId()" class="p-error">Doctor is required</small>
      </div>

      <div class="flex flex-col gap-3">
        <label for="followupDate">Follow-up Date</label>
        <p-datepicker
          name="followupDate"
          [ngModel]="followupDate()"
          (ngModelChange)="followupDate.set($event)"
          dateFormat="yy-mm-dd"
          showIcon
        ></p-datepicker>
        <small *ngIf="!followupDate()" class="p-error">Date is required</small>
      </div>

      <div class="flex justify-between mt-4">
        <p-button
          type="button"
          label="Back"
          icon="pi pi-arrow-left"
          class="p-button-secondary"
          (onClick)="switchToList()"
        ></p-button>

        <p-button
          type="submit"
          [label]="isSubmitting() ? 'Saving...' : 'Submit'"
          [disabled]="isSubmitting()"
          icon="pi pi-check"
        ></p-button>
      </div>
    </form>
  </div>
</div>

<ng-template #loadingContainer>
  <div class="card">
    <div
      class="rounded border border-surface-200 dark:border-surface-700 p-6 bg-surface-0 dark:bg-surface-900"
    >
      <div class="flex mb-4">
        <p-skeleton shape="circle" size="4rem" class="mr-2"></p-skeleton>
        <div>
          <p-skeleton width="10rem" class="mb-2"></p-skeleton>
          <p-skeleton width="5rem" class="mb-2"></p-skeleton>
          <p-skeleton height=".5rem"></p-skeleton>
        </div>
      </div>
      <p-skeleton width="100%" height="150px"></p-skeleton>
      <div class="flex justify-between mt-4">
        <p-skeleton width="4rem" height="2rem"></p-skeleton>
        <p-skeleton width="4rem" height="2rem"></p-skeleton>
      </div>
    </div>
  </div>
</ng-template>

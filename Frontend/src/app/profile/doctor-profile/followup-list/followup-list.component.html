@if(!docStore.isLoadingFol()){
<div class="p-4 border border-slate-200 rounded-lg">
  @if(currentView() === 'list'){
  <div class="flex justify-between gap-4 my-4 flex-3/items-end">
    <p-iconfield styleClass="flex-1/3">
      <p-inputicon styleClass="pi pi-search" />
      <input
        type="text"
        pInputText
        [ngModel]="searchTerm()"
        (ngModelChange)="searchTerm.set($event)"
        placeholder="Patient name..."
        class="w-3/5"
      />
    </p-iconfield>

    <p-select
      [ngModel]="selectedStatus()"
      [options]="statusOptions"
      (ngModelChange)="selectedStatus.set($event)"
      placeholder="Select status"
      class="w-48"
      optionLabel="label"
      optionValue="value"
    >
    </p-select>
  </div>

  <p-table
    [value]="filteredFollowups()"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[5, 10, 20]"
    [responsiveLayout]="'scroll'"
    class="shadow-md rounded-2xl overflow-hidden"
  >
    <ng-template #header>
      <tr>
        <th>Name</th>

        <th>Status</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </ng-template>

    <ng-template #body let-followup>
      <tr>
        <td>
          {{ `${followup.patient.firstName} ${followup.patient.lastName}` }}
        </td>
        <td>
          <p-message
            variant="outlined"
            [severity]="followup.status == 'Pending' ? 'warn' : 'success'"
            styleClass="w-fit"
          >
            {{ followup.status }}
          </p-message>
        </td>
        <td>{{ followup.followupDate }}</td>
        <td class="flex gap-3">
          <p-button
            label="View Patient"
            severity="info"
            raised="true"
            icon="pi pi-user"
          ></p-button>
          @if (followup.status == 'Pending') {
          <p-button
            label="Address"
            variant="outlined"
            raised="true"
            icon="pi pi-pen-to-square"
            (onClick)="showAddressDialog(followup)"
          ></p-button>
          }
        </td>
      </tr>
    </ng-template>

    <ng-template #emptymessage>
      <tr>
        <td colspan="5">No follow-ups found.</td>
      </tr>
    </ng-template>
  </p-table>
  }
  <!-- Followup Form View -->
  <div *ngIf="currentView() === 'form'">
    <!-- Your existing followup creation form -->

    <p-button
      label="Back to List"
      icon="pi pi-arrow-left"
      (onClick)="switchToList()"
    ></p-button>
  </div>

  <!-- Report Form View -->
  <div
    *ngIf="currentView() === 'reportForm'"
    class="border border-black p-4 bg-white rounded shadow"
  >
    <div class="flex justify-between">
      <h2 class="font-title text-2xl">
        Add Report for
        {{
          selectedFollowup()?.patient?.firstName +
            " " +
            selectedFollowup()?.patient?.lastName
        }}
      </h2>
      <p-button
        label="Back to List"
        icon="pi pi-arrow-left"
        (onClick)="switchToList()"
      ></p-button>
    </div>
    <form
      (ngSubmit)="onSubmitReport()"
      #reportForm="ngForm"
      class="mt-4 flex flex-col gap-4"
    >
      <textarea
        name="diagnosis"
        pTextarea
        [(ngModel)]="diagnosis"
        required
        placeholder="Diagnosis"
        rows="3"
        class="p-inputtextarea w-full"
      ></textarea>

      <textarea
        name="medication"
        pTextarea
        [(ngModel)]="medication"
        placeholder="Medication"
        rows="3"
        class="p-inputtextarea w-full"
      ></textarea>

      <textarea
        name="remarks"
        pTextarea
        [(ngModel)]="remarks"
        placeholder="Remarks"
        rows="3"
        class="p-inputtextarea w-full"
      ></textarea>

      <div
        class="grid grid-cols-2 gap-2 max-h-64 overflow-auto border p-2 rounded"
      >
        <label
          class="flex items-center space-x-2"
          *ngFor="let option of testsOptions"
        >
          <input
            type="checkbox"
            [value]="option.value"
            (change)="onCheckboxChange($event)"
            [checked]="selectedTests.includes(option.value)"
          />
          <span>{{ option.label }}</span>
        </label>
      </div>

      <button
        type="submit"
        pButton
        label="Submit Report"
        class="mt-2"
        [disabled]="!reportForm.form.valid"
      ></button>
    </form>
  </div>

  <p-dialog
    header="Confirm Action"
    [visible]="dialogVisible()"
    [modal]="true"
    [closable]="false"
    [style]="{ width: '350px' }"
  >
    <p>What do you want to do with this followup?</p>
    <div class="flex justify-content-between mt-4 gap-2">
      <button
        pButton
        type="button"
        label="Address"
        (click)="addressFollowup()"
      ></button>
      <button
        pButton
        type="button"
        label="Add Report"
        (click)="addReport()"
        class="p-button-secondary"
      ></button>
      <button
        pButton
        type="button"
        label="Cancel"
        class="p-button-text"
        (click)="dialogVisible.set(false)"
      ></button>
    </div>
  </p-dialog>
</div>
} @else {
<div class="card">
  <div
    class="rounded border border-surface-200 dark:border-surface-700 p-6 bg-surface-0 dark:bg-surface-900"
  >
    <div class="flex mb-4">
      <p-skeleton shape="circle" size="4rem" class="mr-2" />
      <div>
        <p-skeleton width="10rem" class="mb-2" />
        <p-skeleton width="5rem" class="mb-2" />
        <p-skeleton height=".5rem" />
      </div>
    </div>
    <p-skeleton width="100%" height="150px" />
    <div class="flex justify-between mt-4">
      <p-skeleton width="4rem" height="2rem" />
      <p-skeleton width="4rem" height="2rem" />
    </div>
  </div>
</div>
}
